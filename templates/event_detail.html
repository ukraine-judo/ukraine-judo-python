{% extends "base.html" %}

{% block title %}{{ event.title }}{% endblock %}

{% block content %}
<!-- Full Width Hero Section -->
<div class="relative w-full h-[60vh] min-h-[500px] overflow-hidden bg-gray-900">
    <!-- Background Image -->
    {% if event.image_url %}
    <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('{{ event.image_url }}');"></div>
    {% else %}
    <div class="absolute inset-0 bg-gradient-to-br from-primary to-blue-700"></div>
    {% endif %}
    
    <!-- Gradient Overlay -->
    <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-black/20 to-black/85"></div>
    
    <!-- Hero Content -->
    <div class="relative h-full w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col justify-end pb-8 md:pb-12">
        <!-- Status Badge -->
        {% if event.status == 'ongoing' %}
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/20 backdrop-blur-md border border-white/30 mb-4 self-start">
            <span class="w-2 h-2 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]"></span>
            <span class="text-xs font-bold text-white uppercase tracking-wider">Live зараз</span>
        </div>
        {% elif days_until is not none and days_until >= 0 %}
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/20 backdrop-blur-md border border-white/30 mb-4 self-start">
            <span class="w-2 h-2 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]"></span>
            <span class="text-xs font-bold text-white uppercase tracking-wider">
                {% if days_until == 0 %}
                Сьогодні
                {% elif days_until == 1 %}
                Завтра
                {% else %}
                Через {{ days_until }} {% if days_until <= 4 %}дні{% else %}днів{% endif %}
                {% endif %}
            </span>
        </div>
        {% endif %}
        
        <!-- Title -->
        <h1 class="text-white text-3xl sm:text-4xl md:text-5xl lg:text-6xl xl:text-7xl font-black leading-tight tracking-[-0.033em] mb-3 md:mb-4 drop-shadow-md">
            {{ event.title }}
        </h1>
        
        <!-- Meta Info -->
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 md:gap-6 lg:gap-8 text-white font-medium drop-shadow-sm text-sm sm:text-base">
            {% if event.date_start %}
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-lg sm:text-xl">calendar_month</span>
                <span>
                    {% if event.date_end and event.date_end != event.date_start %}
                        {{ event.date_start.strftime('%d') }}-{{ event.date_end.strftime('%d %B %Y')
                            .replace('January', 'січня')
                            .replace('February', 'лютого')
                            .replace('March', 'березня')
                            .replace('April', 'квітня')
                            .replace('May', 'травня')
                            .replace('June', 'червня')
                            .replace('July', 'липня')
                            .replace('August', 'серпня')
                            .replace('September', 'вересня')
                            .replace('October', 'жовтня')
                            .replace('November', 'листопада')
                            .replace('December', 'грудня') }}
                    {% else %}
                        {{ event.date_start.strftime('%d %B %Y')
                            .replace('January', 'січня')
                            .replace('February', 'лютого')
                            .replace('March', 'березня')
                            .replace('April', 'квітня')
                            .replace('May', 'травня')
                            .replace('June', 'червня')
                            .replace('July', 'липня')
                            .replace('August', 'серпня')
                            .replace('September', 'вересня')
                            .replace('October', 'жовтня')
                            .replace('November', 'листопада')
                            .replace('December', 'грудня') }}
                    {% endif %}
                </span>
            </div>
            {% endif %}
            
            {% if event.city %}
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-lg sm:text-xl">location_on</span>
                <span>{{ event.city }}{% if event.region %}, {{ event.region }}{% endif %}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Main Content Container -->
<div class="min-h-[50vh] w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
    <div class="flex flex-col lg:flex-row gap-8 lg:gap-12 items-start">
        
        <!-- Main Content Column (Left) -->
        <div class="flex-1 w-full min-w-0 flex flex-col gap-12">
            
            <!-- About Event -->
            {% if event.description %}
            <section>
                <h3 class="text-primary-900 text-2xl font-bold tracking-tight mb-6">Про подію</h3>
                <div class="text-lg leading-relaxed text-[#333333]/90 font-normal prose max-w-none">
                    {{ event.description | safe }}
                </div>
            </section>
            {% endif %}
            
            <!-- Program Schedule -->
            {% if event.program_parsed and event.program_parsed | length > 0 %}
            <section>
                <h3 class="text-primary-900 text-2xl font-bold tracking-tight mb-8">Програма заходу</h3>
                <div class="flex flex-col gap-6">
                    {% for day in event.program_parsed %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <!-- Day Header -->
                        <div class="px-6 py-4 bg-gray-50/60 border-b border-gray-100 flex items-center gap-3">
                            <div class="bg-white p-1.5 rounded-md shadow-sm border border-gray-100 text-primary">
                                <span class="material-symbols-outlined text-xl block">calendar_month</span>
                            </div>
                            <h4 class="text-lg font-bold text-primary-900">
                                {% if day.get('date') %}
                                    {% set date_str = day.date %}
                                    {% if date_str is string and '-' in date_str %}
                                        {# Parse date string YYYY-MM-DD #}
                                        {% set date_parts = date_str.split('-') %}
                                        {% set year = date_parts[0]|int %}
                                        {% set month = date_parts[1]|int %}
                                        {% set day_num = date_parts[2]|int %}
                                        
                                        {# Ukrainian month names (genitive case) #}
                                        {% set months_uk = {
                                            1: 'січня', 2: 'лютого', 3: 'березня', 4: 'квітня',
                                            5: 'травня', 6: 'червня', 7: 'липня', 8: 'серпня',
                                            9: 'вересня', 10: 'жовтня', 11: 'листопада', 12: 'грудня'
                                        } %}
                                        
                                        {# Calculate day of week (simplified Zeller's algorithm) #}
                                        {% set m = month %}
                                        {% set y = year %}
                                        {% if m < 3 %}
                                            {% set m = m + 12 %}
                                            {% set y = y - 1 %}
                                        {% endif %}
                                        {% set k = y % 100 %}
                                        {% set j = y // 100 %}
                                        {% set h = (day_num + ((13 * (m + 1)) // 5) + k + (k // 4) + (j // 4) - (2 * j)) % 7 %}
                                        
                                        {# Convert to weekday (0=Saturday, 1=Sunday, ..., 6=Friday) #}
                                        {% set weekday = (h + 5) % 7 %}
                                        
                                        {# Ukrainian weekday names #}
                                        {% set weekdays_uk = {
                                            0: 'понеділок', 1: 'вівторок', 2: 'середа', 3: 'четвер',
                                            4: 'п\'ятниця', 5: 'субота', 6: 'неділя'
                                        } %}
                                        
                                        {{ day_num }} {{ months_uk[month] }}, {{ weekdays_uk[weekday] }}
                                    {% else %}
                                        {{ day.date }}
                                    {% endif %}
                                {% endif %}
                            </h4>
                        </div>
                        
                        <!-- Day Schedule -->
                        <div class="p-6 md:p-8">
                            <div class="space-y-6">
                                {% if day.get('items') %}
                                    {% for item in day['items'] %}
                                    <div class="flex flex-col md:flex-row gap-4 md:gap-10">
                                        {% if item.get('start') or item.get('end') %}
                                        <div class="w-36 shrink-0">
                                            <span class="text-sm font-bold font-mono text-primary-900 bg-primary-50 px-3 py-1.5 rounded-md">
                                                {% if item.get('start') and item.get('end') %}
                                                {{ item.start }} - {{ item.end }}
                                                {% elif item.get('start') %}
                                                {{ item.start }}
                                                {% else %}
                                                {{ item.end }}
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                        
                                        <div class="flex-1 pb-6 border-b border-gray-50 last:border-0 last:pb-0">
                                            {% if item.get('activity') %}
                                            <p class="text-base text-gray-700 leading-relaxed">{{ item.activity }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
            
            <!-- Info Blocks Grid -->
            {% if event.info_blocks_parsed and event.info_blocks_parsed | length > 0 %}
            <section>
                <h3 class="text-primary-900 text-2xl font-bold tracking-tight mb-6">Інформація</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    {% for block in event.info_blocks_parsed %}
                    <div class="bg-white border border-gray-100 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                        <!-- Icon -->
                        <div class="w-10 h-10 rounded-full 
                            {% if block.type == 'expenses' %}bg-purple-50 text-purple-600
                            {% elif block.type == 'prizes' %}bg-yellow-50 text-yellow-600
                            {% elif block.type == 'applications' %}bg-green-50 text-green-600
                            {% elif block.type == 'important' %}bg-red-50 text-red-600
                            {% else %}bg-primary-50 text-primary
                            {% endif %}
                            flex items-center justify-center mb-4">
                            {% if block.type == 'expenses' %}
                            <span class="material-symbols-outlined">payments</span>
                            {% elif block.type == 'prizes' %}
                            <span class="material-symbols-outlined">emoji_events</span>
                            {% elif block.type == 'applications' %}
                            <span class="material-symbols-outlined">how_to_reg</span>
                            {% elif block.type == 'important' %}
                            <span class="material-symbols-outlined">priority_high</span>
                            {% else %}
                            <span class="material-symbols-outlined">info</span>
                            {% endif %}
                        </div>
                        
                        <!-- Title -->
                        <h4 class="text-lg font-bold text-primary-900 mb-2">{{ block.title }}</h4>
                        
                        <!-- Content -->
                        <div class="text-sm text-gray-600 leading-relaxed prose prose-sm max-w-none">
                            {{ block.content | safe }}
                        </div>
                        
                        <!-- Deadline if exists -->
                        {% if block.get('deadline') %}
                        <div class="mt-4 px-3 py-2 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                            <p class="text-xs font-bold text-yellow-800 uppercase">Дедлайн</p>
                            <p class="text-sm font-semibold text-yellow-900">{{ block.deadline }}</p>
                        </div>
                        {% endif %}
                        
                        <!-- FITOFAN CTA if exists -->
                        {% if block.get('fitofan_url') %}
                        <div class="mt-4">
                            <a href="{{ block.fitofan_url }}" target="_blank" 
                               class="flex items-center justify-center gap-2 px-4 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold text-sm transition-all shadow-sm hover:shadow-md">
                                <span class="material-symbols-outlined text-lg">open_in_new</span>
                                <span>Подати заявку на FITOFAN</span>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
            
            <!-- Empty State if no content -->
            {% if not event.description and not (event.program_parsed and event.program_parsed | length > 0) and not (event.info_blocks_parsed and event.info_blocks_parsed | length > 0) %}
            <section class="py-16 text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                    <span class="material-symbols-outlined text-3xl text-gray-400">event_note</span>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Детальна інформація незабаром</h3>
                <p class="text-gray-500">Ми працюємо над наповненням сторінки події</p>
            </section>
            {% endif %}
            
        </div>
        
        <!-- Sidebar (Right) -->
        <aside class="w-full lg:w-[340px] shrink-0">
            <div class="lg:sticky lg:top-[90px] flex flex-col gap-6">
                
                <!-- Event Summary Card -->
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5">
                    <h4 class="text-base font-bold text-primary-900 mb-4 pb-3 border-b border-gray-50 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary text-[20px]">info</span>
                        Основна інформація
                    </h4>
                    
                    <ul class="space-y-4">
                        {% if event.date_start %}
                        <li class="flex items-start gap-3">
                            <div class="mt-0.5 w-6 flex justify-center text-gray-400">
                                <span class="material-symbols-outlined text-[18px]">calendar_month</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-wide font-medium mb-0.5">Дата</p>
                                <p class="text-sm font-semibold text-primary-900">
                                    {% if event.date_end and event.date_end != event.date_start %}
                                        {{ event.date_start.strftime('%d') }}-{{ event.date_end.strftime('%d %B %Y')
                                            .replace('January', 'січня')
                                            .replace('February', 'лютого')
                                            .replace('March', 'березня')
                                            .replace('April', 'квітня')
                                            .replace('May', 'травня')
                                            .replace('June', 'червня')
                                            .replace('July', 'липня')
                                            .replace('August', 'серпня')
                                            .replace('September', 'вересня')
                                            .replace('October', 'жовтня')
                                            .replace('November', 'листопада')
                                            .replace('December', 'грудня') }}
                                    {% else %}
                                        {{ event.date_start.strftime('%d %B %Y')
                                            .replace('January', 'січня')
                                            .replace('February', 'лютого')
                                            .replace('March', 'березня')
                                            .replace('April', 'квітня')
                                            .replace('May', 'травня')
                                            .replace('June', 'червня')
                                            .replace('July', 'липня')
                                            .replace('August', 'серпня')
                                            .replace('September', 'вересня')
                                            .replace('October', 'жовтня')
                                            .replace('November', 'листопада')
                                            .replace('December', 'грудня') }}
                                    {% endif %}
                                </p>
                            </div>
                        </li>
                        {% endif %}
                        
                        {% if event.city %}
                        <li class="flex items-start gap-3">
                            <div class="mt-0.5 w-6 flex justify-center text-gray-400">
                                <span class="material-symbols-outlined text-[18px]">location_on</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-wide font-medium mb-0.5">Локація</p>
                                <p class="text-sm font-semibold text-primary-900">{{ event.city }}</p>
                                {% if event.address %}
                                <p class="text-xs text-gray-500 mt-1">{{ event.address }}</p>
                                {% endif %}
                            </div>
                        </li>
                        {% endif %}
                        
                        {% if event.organizer %}
                        <li class="flex items-start gap-3">
                            <div class="mt-0.5 w-6 flex justify-center text-gray-400">
                                <span class="material-symbols-outlined text-[18px]">group</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-wide font-medium mb-0.5">Організатор</p>
                                <p class="text-sm font-semibold text-primary-900">{{ event.organizer }}</p>
                            </div>
                        </li>
                        {% endif %}
                        
                        {% if event.age_group %}
                        <li class="flex items-start gap-3">
                            <div class="mt-0.5 w-6 flex justify-center text-gray-400">
                                <span class="material-symbols-outlined text-[18px]">badge</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-wide font-medium mb-0.5">Вікова група</p>
                                <p class="text-sm font-semibold text-primary-900">{{ event.age_group_label }}</p>
                            </div>
                        </li>
                        {% endif %}
                        
                        {% if event.category %}
                        <li class="flex items-start gap-3">
                            <div class="mt-0.5 w-6 flex justify-center text-gray-400">
                                <span class="material-symbols-outlined text-[18px]">emoji_events</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-wide font-medium mb-0.5">Категорія</p>
                                <p class="text-sm font-semibold text-primary-900">{{ event.category_label }}</p>
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                
                <!-- Live Streams -->
                {% if event.live_streams_parsed and event.live_streams_parsed | length > 0 %}
                <div class="bg-white rounded-xl border border-gray-100 shadow-lg shadow-gray-200/50 p-5 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-base font-bold text-primary-900">Трансляції</h4>
                        <span class="px-2 py-0.5 bg-red-100 text-red-600 rounded text-[10px] font-bold uppercase tracking-wider flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                            Live
                        </span>
                    </div>
                    
                    <div class="space-y-3">
                        {% for stream in event.live_streams_parsed %}
                        <a href="{{ stream.url }}" target="_blank" 
                           class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition-colors group cursor-pointer">
                            <div class="relative w-12 h-12 rounded-lg bg-gray-900 flex items-center justify-center shrink-0">
                                <span class="material-symbols-outlined text-white group-hover:scale-110 transition-transform">play_arrow</span>
                            </div>
                            <div class="min-w-0">
                                <p class="text-sm font-bold text-primary-900 group-hover:text-primary transition-colors truncate">
                                    {{ stream.title }}
                                </p>
                                <p class="text-xs text-gray-500">
                                    {% if 'youtube' in stream.url %}YouTube
                                    {% elif 'judotv' in stream.url %}JudoTV
                                    {% else %}Live{% endif %}
                                </p>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Documents & Protocols -->
                {% if event.regulation_url or (event.protocols_parsed and event.protocols_parsed | length > 0) %}
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5">
                    <h4 class="text-base font-bold text-primary-900 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">description</span>
                        Документи та протоколи
                    </h4>
                    
                    <ul class="space-y-3">
                        <!-- Regulation Document -->
                        {% if event.regulation_url %}
                        <li>
                            <a href="{{ event.regulation_url }}" target="_blank" class="flex items-start gap-3 group">
                                <div class="mt-0.5 bg-primary-50 p-1.5 rounded border border-primary/10 text-primary">
                                    <span class="material-symbols-outlined text-[18px] block">picture_as_pdf</span>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-semibold text-gray-800 group-hover:text-primary transition-colors">
                                        Регламент
                                    </p>
                                    <p class="text-xs text-gray-400">PDF документ</p>
                                </div>
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- Protocols -->
                        {% if event.protocols_parsed and event.protocols_parsed | length > 0 %}
                            {% for protocol in event.protocols_parsed %}
                            <li>
                                <a href="/static/{{ protocol.path }}" target="_blank" class="flex items-start gap-3 group">
                                    <div class="mt-0.5 bg-primary-50 p-1.5 rounded border border-primary/10 text-primary">
                                        <span class="material-symbols-outlined text-[18px] block">picture_as_pdf</span>
                                    </div>
                                    <div class="min-w-0">
                                        <p class="text-sm font-semibold text-gray-800 group-hover:text-primary transition-colors">
                                            {{ protocol.name }}
                                        </p>
                                        <p class="text-xs text-gray-400">PDF документ</p>
                                    </div>
                                </a>
                            </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Weight Categories -->
                {% if event.weight_classes_parsed and event.weight_classes_parsed | length > 0 %}
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5">
                    <h4 class="text-base font-bold text-primary-900 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">fitness_center</span>
                        Вагові категорії
                    </h4>
                    
                    <div class="space-y-4">
                        {% for division in event.weight_classes_parsed %}
                        <div>
                            <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                                {{ division.get('division', 'Категорія') }}
                            </h5>
                            <div class="flex flex-wrap gap-1.5">
                                {% if division.get('weightClasses') %}
                                    {% for weight in division['weightClasses'] %}
                                    <span class="px-2 py-1 bg-gray-50 text-gray-600 rounded text-xs font-medium border border-gray-100 hover:border-primary/30 cursor-default">
                                        {{ weight }}
                                    </span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Contacts -->
                {% if event.contacts_parsed and event.contacts_parsed | length > 0 %}
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5">
                    <h4 class="text-base font-bold text-primary-900 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">contact_phone</span>
                        Контакти
                    </h4>
                    
                    <div class="space-y-3">
                        {% for contact in event.contacts_parsed %}
                        <div class="p-3 rounded-lg bg-gray-50 border border-gray-100">
                            <p class="font-bold text-sm text-gray-900 mb-1">{{ contact.name }}</p>
                            <a href="tel:{{ contact.phone }}" class="text-sm text-primary hover:text-primary/80 transition-colors">
                                {{ contact.phone }}
                            </a>
                            {% if contact.get('comments') %}
                            <p class="text-xs text-gray-500 mt-1">{{ contact.comments }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
            </div>
        </aside>
        
    </div>
</div>

<!-- Back Button -->
<div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
    <a href="/calendar" data-page="calendar" onclick="navigateToPage(event, '/calendar')" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-900 font-bold text-sm hover:border-primary hover:bg-blue-50 hover:text-primary transition-all group shadow-sm hover:shadow-md">
        <span class="material-symbols-outlined text-[20px] group-hover:-translate-x-1 transition-transform">arrow_back</span>
        <span>Повернутися до календаря</span>
    </a>
</div>

{% endblock %}
